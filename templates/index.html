<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Buscador de PDFs - Información de Equipos</title>
  <style>
    body {
      font-family: "Segoe UI", Roboto, Arial, sans-serif;
      background: #f3f6fa;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 800px;
      margin: 50px auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
      padding: 30px;
    }

    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 25px;
    }

    .search-block {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      position: relative;
    }

    input[type="text"] {
      padding: 10px 15px;
      border: 1px solid #ccc;
      border-radius: 25px;
      width: 250px;
      transition: all 0.2s ease;
    }

    input[type="text"]:focus {
      border-color: #2980b9;
      box-shadow: 0 0 6px rgba(41, 128, 185, 0.3);
      outline: none;
    }

    select {
      padding: 10px;
      border-radius: 25px;
      border: 1px solid #ccc;
      width: 200px;
    }

    button {
      padding: 10px 20px;
      border-radius: 25px;
      border: none;
      background: #2980b9;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    button:hover {
      background: #3498db;
    }

    /* Dropdown de sugerencias */
    #sugerencias {
      position: absolute;
      top: 45px;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      width: 250px;
      border: 1px solid #ccc;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      z-index: 100;
      max-height: 220px;
      overflow-y: auto;
      display: none;
    }

    #sugerencias li {
      padding: 8px 12px;
      cursor: pointer;
      transition: background 0.2s;
      text-align: left;
    }

    #sugerencias li:hover {
      background: #f0f0f0;
    }

    mark {
      background: #fdf39d;
      color: #333;
      border-radius: 3px;
    }

    /* Tarjetas PDF */
    .pdf-card {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      margin-bottom: 25px;
      transition: transform 0.15s;
    }

    .pdf-card:hover {
      transform: translateY(-3px);
    }

    .pdf-card h3 {
      margin: 0 0 8px;
      color: #2980b9;
    }

    .pdf-card small {
      color: #666;
    }

    iframe {
      width: 100%;
      height: 400px;
      border: none;
      border-radius: 6px;
      margin-top: 10px;
    }

    @media (max-width: 600px) {
      .container {
        margin: 15px;
        padding: 15px;
      }
      input,
      select,
      button {
        width: 100%;
      }
      #sugerencias {
        width: 100%;
        left: 0;
        transform: none;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Información de Equipos</h1>
    <div class="search-block">
      <input type="text" id="busqueda" placeholder="Nombre del PDF..." autocomplete="off" />
      <select id="filtroCarpeta"></select>
      <button id="btnBuscar">Buscar</button>
      <ul id="sugerencias"></ul>
    </div>
    <div id="resultadoPDF" style="margin-top: 30px; text-align: center;"></div>
  </div>

  <script>
    let folders = [];
    let cachePDFs = {};
    let allPDFs = [];

    document.addEventListener("DOMContentLoaded", async () => {
      const filtroCarpeta = document.getElementById("filtroCarpeta");
      const busquedaInput = document.getElementById("busqueda");
      const sugerencias = document.getElementById("sugerencias");
      const btnBuscar = document.getElementById("btnBuscar");

      try {
        const res = await fetch("/folders");
        folders = await res.json();

        filtroCarpeta.innerHTML = '<option value="">Todas las carpetas</option>';
        folders.forEach(f => {
          const depth = f.path.split("/").length;
          if (depth <= 2) { // solo mostrar las principales
            const option = document.createElement("option");
            option.value = f.id;
            option.textContent = f.path;
            filtroCarpeta.appendChild(option);
          }
        });

        // Precarga inicial ligera
        precargarPDFsInicial();

        // Eventos
        busquedaInput.addEventListener("input", mostrarSugerencias);
        busquedaInput.addEventListener("keydown", e => {
          if (e.key === "Enter") {
            e.preventDefault();
            buscar();
          }
        });
        btnBuscar.addEventListener("click", buscar);
        filtroCarpeta.addEventListener("change", buscar);
      } catch (err) {
        console.error("Error al cargar carpetas:", err);
      }
    });

    async function precargarPDFsInicial() {
      for (const f of folders) {
        if (!cachePDFs[f.id]) fetchPDFs(f.id);
      }
    }

    async function fetchPDFs(folderId) {
      try {
        const res = await fetch(`/pdfs?folder_id=${folderId}`);
        const data = await res.json();
        if (data.error) return [];
        const folder = folders.find(f => f.id === folderId);
        cachePDFs[folderId] = data.map(p => ({ ...p, carpeta: folder.path }));
        allPDFs = Object.values(cachePDFs).flat();
        return cachePDFs[folderId];
      } catch (e) {
        console.error(e);
        return [];
      }
    }

    async function buscar() {
      const carpeta = document.getElementById("filtroCarpeta").value;
      const texto = document.getElementById("busqueda").value.trim().toLowerCase();
      const contenedor = document.getElementById("resultadoPDF");
      sugerencias.style.display = "none";

      contenedor.innerHTML = "<p>Cargando resultados...</p>";

      let resultados = [];

      if (carpeta) {
        if (!cachePDFs[carpeta]) await fetchPDFs(carpeta);
        resultados = cachePDFs[carpeta];
      } else {
        if (allPDFs.length === 0) {
          await Promise.all(folders.map(f => fetchPDFs(f.id)));
        }
        resultados = allPDFs;
      }

      if (texto) {
        resultados = resultados.filter(p =>
          p.nombre.toLowerCase().includes(texto)
        );
      }

      mostrarResultados(resultados);
    }

    function mostrarResultados(resultados) {
      const contenedor = document.getElementById("resultadoPDF");
      contenedor.innerHTML = "";
      if (resultados.length === 0) {
        contenedor.textContent = "No se encontraron resultados.";
        return;
      }

      resultados.forEach(p => {
        contenedor.innerHTML += `
          <div class="pdf-card">
            <h3>${p.nombre}</h3>
            <small>Carpeta: ${p.carpeta || "Raíz"}</small><br>
            <a href="${p.url}" target="_blank">Abrir en Google Drive</a>
            <iframe src="${p.url}" loading="lazy"></iframe>
          </div>
        `;
      });
    }

    function mostrarSugerencias() {
      const texto = document.getElementById("busqueda").value.trim().toLowerCase();
      const carpeta = document.getElementById("filtroCarpeta").value;
      const lista = document.getElementById("sugerencias");
      lista.innerHTML = "";

      if (!texto) {
        lista.style.display = "none";
        return;
      }

      let base = carpeta ? cachePDFs[carpeta] || [] : allPDFs;

      const resultados = base.filter(p => p.nombre.toLowerCase().includes(texto)).slice(0, 10);
      if (resultados.length === 0) {
        lista.style.display = "none";
        return;
      }

      const regex = new RegExp(`(${texto})`, "gi");
      resultados.forEach(p => {
        const li = document.createElement("li");
        li.innerHTML = `${p.nombre.replace(regex, "<mark>$1</mark>")} <small>(${p.carpeta || "Raíz"})</small>`;
        li.onclick = () => {
          document.getElementById("busqueda").value = p.nombre;
          lista.style.display = "none";
          buscar();
        };
        lista.appendChild(li);
      });

      lista.style.display = "block";
    }
  </script>
</body>
</html>
